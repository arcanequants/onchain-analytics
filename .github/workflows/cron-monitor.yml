name: CRON Job Monitoring

on:
  schedule:
    # Run every hour to check CRON jobs health
    - cron: '0 * * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  monitor-cron-jobs:
    name: Monitor CRON Jobs
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check gas collection CRON
        run: |
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            "https://vectorialdata.com/api/health")

          if [ $RESPONSE -ne 200 ]; then
            echo "‚ùå Health check failed with status: $RESPONSE"
            exit 1
          else
            echo "‚úÖ Health check passed"
          fi

      - name: Query recent CRON executions
        run: |
          # Check if CRON jobs ran in last hour
          curl -X GET \
            "${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}/rest/v1/cron_executions?select=*&order=created_at.desc&limit=10" \
            -H "apikey: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}"

      - name: Send Slack notification on failure
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: 'üö® CRON jobs health check failed!'
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
